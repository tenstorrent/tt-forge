
name: Test Release RC/Stable Lifecycle
on:
    push:
      branches:
        - main
      paths:
        - '.github/scripts/model-compatible-table/**'
        - '.github/scripts/wheel-version-updater.sh'
        - '.github/scripts/prune-nightly-branches.sh'
        - '.github/scripts/check_release.sh'
        - '.github/scripts/wait-on-tt-pypi-wheels.sh'
        - '.github/workflows/update-release.yml'
        - '.github/workflows/daily-releaser.yml'
        - '.github/workflows/nightly-release.yml'
        - '.github/workflows/release.yml'
        - '.github/workflows/create-version-branches.yml'
        - '.github/workflows/bump-version.yml'
        - '.github/workflows/promote-stable.yml'
        - '.github/actions/mock-commit-tag-merge/**'
        - '.github/actions/create-rc-branch/**'
        - '.github/actions/docs-generator/**'
        - '.github/actions/find-workflow/**'
        - '.github/actions/get-release-branches/**'
        - '.github/actions/get-repos/**'
        - '.github/actions/build-release/**'
        - '.github/actions/uplift-artifacts/**'
        - '.github/actions/set-release-facts/**'
        - '.github/actions/install-verification/**'
        - '.github/actions/publish-tenstorrent-pypi/**'
        - '.github/actions/trigger-workflow/**'
        - '.github/actions/wait-workflow/**'
        - '.github/actions/publish-github-release/**'
        - '.github/workflows/test-nightly-releaser.yml'
        - '.github/workflows/test-rc-stable-release-lifecycle.yml'
        - '.github/scripts/pyproject.toml'
        - '.github/scripts/template-setup.py'
    pull_request:
      types: [opened, synchronize, reopened, ready_for_review]
      branches: [ "main" ]
      paths:
        - '.github/scripts/model-compatible-table/**'
        - '.github/scripts/wheel-version-updater.sh'
        - '.github/scripts/prune-nightly-branches.sh'
        - '.github/scripts/check_release.sh'
        - '.github/scripts/wait-on-tt-pypi-wheels.sh'
        - '.github/workflows/update-release.yml'
        - '.github/workflows/daily-releaser.yml'
        - '.github/workflows/nightly-release.yml'
        - '.github/workflows/release.yml'
        - '.github/workflows/create-version-branches.yml'
        - '.github/workflows/bump-version.yml'
        - '.github/workflows/promote-stable.yml'
        - '.github/actions/mock-commit-tag-merge/**'
        - '.github/actions/create-rc-branch/**'
        - '.github/actions/docs-generator/**'
        - '.github/actions/find-workflow/**'
        - '.github/actions/get-release-branches/**'
        - '.github/actions/get-repos/**'
        - '.github/actions/build-release/**'
        - '.github/actions/uplift-artifacts/**'
        - '.github/actions/set-release-facts/**'
        - '.github/actions/install-verification/**'
        - '.github/actions/publish-tenstorrent-pypi/**'
        - '.github/actions/trigger-workflow/**'
        - '.github/actions/wait-workflow/**'
        - '.github/actions/publish-github-release/**'
        - '.github/workflows/test-nightly-releaser.yml'
        - '.github/workflows/test-rc-stable-release-lifecycle.yml'
        - '.github/scripts/pyproject.toml'
        - '.github/scripts/template-setup.py'
    workflow_dispatch:
      inputs:
        delete-drafts:
          type: boolean
          default: true
          description: Delete drafts

permissions:
  pages: write
  id-token: write
  contents: write
  actions: write
  packages: write
  attestations: write

env:
  FIRST_COMMIT_PRE_RELEASE_TAG: "draft.tt-mlir.first-commit-pre-release-${{ github.run_id }}-${{ github.run_attempt }}"
  SECOND_COMMIT_PRE_RELEASE_TAG: "draft.tt-mlir.second-commit-pre-release-${{ github.run_id }}-${{ github.run_attempt }}"
  FIRST_COMMIT_STABLE_TAG: "draft.tt-mlir.first-commit-stable-${{ github.run_id }}-${{ github.run_attempt }}"
  SECOND_COMMIT_STABLE_TAG: "draft.tt-mlir.second-commit-stable-${{ github.run_id }}-${{ github.run_attempt }}"
  MOCK_MERGE_BRANCH: "draft-tt-mlir-release-mock-branch-${{ github.run_id }}-${{ github.run_attempt }}"

jobs:

  get-repos:
    if: always()
    outputs:
      json_results: ${{ steps.get-repos.outputs.json_results }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get Repos
        id: get-repos
        uses: ./.github/actions/get-repos
        with:
          repo: 'tt-mlir'

  expected-artifacts:
    if: always()
    needs:
      - get-repos
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Expected Artifacts
    outputs:
      expected_tags: ${{ steps.set-expected.outputs.expected_tags }}
      expected_branches: ${{ steps.set-expected.outputs.expected_branches }}
      draft_release_branch: ${{ steps.set-expected.outputs.draft_release_branch }}
      expected_release_tags: ${{ steps.set-expected.outputs.expected_release_tags }}
      non_expected_tags: ${{ steps.set-expected.outputs.non_expected_tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version file
        id: read-version
        run: |
          source .version
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set expected artifacts
        id: set-expected
        run: |
          # Expected mock merge tags to simulate commits with tags being merged to release branches
          expected_mock_merge_tags=(
            "${{ env.FIRST_COMMIT_PRE_RELEASE_TAG }}"
            "${{ env.SECOND_COMMIT_PRE_RELEASE_TAG }}"
            "${{ env.FIRST_COMMIT_STABLE_TAG }}"
            "${{ env.SECOND_COMMIT_STABLE_TAG }}"
          )

          # Expected release tags for draft releases
          expected_release_tags=(
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.0rc1"
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.0rc2"
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.0rc3"
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.0"
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.1"
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.2"
          )

          # Non expected tags
          non_expected_tags=(
            "draft.${{ matrix.repo_short }}.${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}.0rc4"
          )

          # All expected tags
          expected_tags=(
            "${expected_mock_merge_tags[*]}"
            "${expected_release_tags[*]}"
          )

          # Expected branch
          draft_release_branch="draft-${{ matrix.repo_short }}-release-${{ steps.read-version.outputs.major }}.${{ steps.read-version.outputs.minor }}"
          expected_branches=("$draft_release_branch"
                  "${{ env.MOCK_MERGE_BRANCH }}"
                  )

          # Convert arrays to space-separated strings for easier handling in bash
          echo "expected_tags=${expected_tags[*]}" >> $GITHUB_OUTPUT
          echo "expected_branches=${expected_branches[*]}" >> $GITHUB_OUTPUT
          echo "draft_release_branch=$draft_release_branch" >> $GITHUB_OUTPUT
          echo "expected_release_tags=${expected_release_tags[*]}" >> $GITHUB_OUTPUT
          echo "non_expected_tags=${non_expected_tags[*]}" >> $GITHUB_OUTPUT


  mock-successful-workflow-pre-release-branch:
    outputs:
      run_head_sha: ${{ steps.trigger-workflow.outputs.run_head_sha }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/trigger-workflow
        id: trigger-workflow
        with:
          workflow_name: 'Mock Successful'
          wait: true
          watch_interval: 5

  create-version-branch:
    needs:
      - get-repos
      - mock-successful-workflow-pre-release-branch
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Create Version branch
    uses: ./.github/workflows/create-version-branches.yml
    secrets: inherit
    with:
      repo: ${{ matrix.repo }}
      draft: true
      draft_slug_name: ${{ matrix.repo_short }}
      workflow_allow_failed: false
      workflow: 'Mock Successful'
      commit: ${{ needs.mock-successful-workflow-pre-release-branch.outputs.run_head_sha }}
      ignore_artifacts: true

  get-release-branches:
    outputs:
      json_results: ${{ steps.get-release-branches.outputs.json_results }}
      no_release_branches_or_new_commits: ${{ steps.get-release-branches.outputs.no_release_branches_or_new_commits }}
    needs:
      - get-repos
      - create-version-branch
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Get Release RC Branches
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get Release Branches
        id: get-release-branches
        uses: ./.github/actions/get-release-branches
        with:
          repo: ${{ matrix.repo }}
          repo_short: ${{ matrix.repo_short }}
          draft: true
          ignore_update_check: true

  first-commit-successful-pre-release-branch:
    needs:
      - get-release-branches
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    name: ${{ matrix.repo_short }} First RC Commit Successful
    runs-on: ubuntu-latest
    outputs:
      new_version_tag: ${{ steps.mock-commit-tag-merge.outputs.new_version_tag }}
      branch_name: ${{ steps.mock-commit-tag-merge.outputs.branch_name }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Mock commit & tag & merge to release branch
        id: mock-commit-tag-merge
        uses: ./.github/actions/mock-commit-tag-merge
        with:
          gh_token: ${{ secrets.TT_FORGE_RELEASER }}
          gpg_private_key: ${{ secrets.FORGE_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.FORGE_GPG_PASSPHRASE }}
          mock_merge_branch_tag: ${{ env.FIRST_COMMIT_PRE_RELEASE_TAG }}
          mock_merge_branch: ${{ env.MOCK_MERGE_BRANCH }}
          release_branch: ${{ matrix.branch }}
      - uses: actions/checkout@v4
      - uses: ./.github/actions/trigger-workflow
        with:
          workflow_name: 'Mock Successful'
          wait: true
          branch: ${{ matrix.branch }}
          watch_interval: 5


  release-rc-first-commit-observed:
    needs:
      - get-repos
      - first-commit-successful-pre-release-branch
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    uses: ./.github/workflows/update-releases.yml
    secrets: inherit
    name: ${{ matrix.repo_short }} Update RC on observed first commit
    with:
      draft: true
      repo: ${{ matrix.repo }}
      overwrite_releases: false

  second-commit-successful-pre-release-branch:
    needs:
      - get-release-branches
      - release-rc-first-commit-observed
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Second RC Commit Successful
    runs-on: ubuntu-latest
    outputs:
      new_version_tag: ${{ steps.mock-commit-tag-merge.outputs.new_version_tag }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Mock commit & tag & merge to release branch
        id: mock-commit-tag-merge
        uses: ./.github/actions/mock-commit-tag-merge
        with:
          gh_token: ${{ secrets.TT_FORGE_RELEASER }}
          gpg_private_key: ${{ secrets.FORGE_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.FORGE_GPG_PASSPHRASE }}
          mock_merge_branch_tag: ${{ env.SECOND_COMMIT_PRE_RELEASE_TAG }}
          mock_merge_branch: ${{ env.MOCK_MERGE_BRANCH }}
          release_branch: ${{ matrix.branch }}
      - uses: actions/checkout@v4
      - uses: ./.github/actions/trigger-workflow
        with:
          workflow_name: 'Mock Successful'
          wait: true
          branch: ${{ matrix.branch }}
          watch_interval: 5

  bump-rc-version-observed:
    needs:
      - second-commit-successful-pre-release-branch
      - get-release-branches
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    uses: ./.github/workflows/bump-version.yml
    secrets: inherit
    name: ${{ matrix.repo_short }} Bump RC Version on observed second commit
    with:
      draft: true
      repo: ${{ matrix.repo }}
      branch: ${{ matrix.branch }}

  promote-stable:
    needs:
      - get-repos
      - bump-rc-version-observed
      - get-release-branches
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Promote RC to Stable
    secrets: inherit
    uses: ./.github/workflows/promote-stable.yml
    with:
      draft: true
      repo: ${{ matrix.repo }}
      release_branch: ${{ matrix.branch }}

  first-commit-successful-stable-branch:
    needs:
      - get-release-branches
      - promote-stable
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    name: ${{ matrix.repo_short }} First Stable/Patch Commit Successful
    runs-on: ubuntu-latest
    outputs:
      new_version_tag: ${{ steps.mock-commit-tag-merge.outputs.new_version_tag }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Mock commit & tag & merge to release branch
        id: mock-commit-tag-merge
        uses: ./.github/actions/mock-commit-tag-merge
        with:
          gh_token: ${{ secrets.TT_FORGE_RELEASER }}
          gpg_private_key: ${{ secrets.FORGE_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.FORGE_GPG_PASSPHRASE }}
          mock_merge_branch_tag: ${{ env.FIRST_COMMIT_STABLE_TAG }}
          mock_merge_branch: ${{ env.MOCK_MERGE_BRANCH }}
          release_branch: ${{ matrix.branch }}
      - uses: actions/checkout@v4
      - uses: ./.github/actions/trigger-workflow
        with:
          workflow_name: 'Mock Successful'
          wait: true
          branch: ${{ matrix.branch }}
          watch_interval: 5

  release-stable-first-commit-observed:
    needs:
      - get-repos
      - first-commit-successful-stable-branch
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    uses: ./.github/workflows/update-releases.yml
    secrets: inherit
    name: ${{ matrix.repo_short }} Update Stable on observed first commit
    with:
      draft: true
      repo: ${{ matrix.repo }}
      overwrite_releases: false

  second-commit-successful-stable-branch:
    needs:
      - get-release-branches
      - release-stable-first-commit-observed
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Second Stable/Patch Commit Successful
    runs-on: ubuntu-latest
    outputs:
      new_version_tag: ${{ steps.mock-commit-tag-merge.outputs.new_version_tag }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Mock commit & tag & merge to release branch
        id: mock-commit-tag-merge
        uses: ./.github/actions/mock-commit-tag-merge
        with:
          gh_token: ${{ secrets.TT_FORGE_RELEASER }}
          gpg_private_key: ${{ secrets.FORGE_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.FORGE_GPG_PASSPHRASE }}
          mock_merge_branch_tag: ${{ env.SECOND_COMMIT_STABLE_TAG }}
          mock_merge_branch: ${{ env.MOCK_MERGE_BRANCH }}
          release_branch: ${{ matrix.branch }}
      - uses: actions/checkout@v4
      - uses: ./.github/actions/trigger-workflow
        with:
          workflow_name: 'Mock Successful'
          wait: true
          branch: ${{ matrix.branch }}
          watch_interval: 5

  bump-stable-version-observed:
    needs:
      - second-commit-successful-stable-branch
      - get-release-branches
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-release-branches.outputs.json_results) }}
    uses: ./.github/workflows/bump-version.yml
    secrets: inherit
    name: ${{ matrix.repo_short }} Bump Stable Version on observed second commit
    with:
      draft: true
      repo: ${{ matrix.repo }}
      branch: ${{ matrix.branch }}


  validate-draft-artifacts:
    if: always()
    needs:
      - bump-stable-version-observed
      - get-repos
      - expected-artifacts
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-repos.outputs.json_results) }}
    name: ${{ matrix.repo_short }} Validate Draft Artifacts
    outputs:
      expected_tags: ${{ steps.set-expected.outputs.expected_tags }}
      expected_branches: ${{ steps.set-expected.outputs.expected_branches }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate draft tags exist
        run: |
          echo "Validating draft tags for ${{ matrix.repo_short }}..."

          # Get all tags on draft release branch
          all_tags=$(git tag --merged origin/${{ needs.expected-artifacts.outputs.draft_release_branch }} --sort=creatordate --sort=taggerdate )

          # Check each expected tag
          missing_tags=()
          for tag in ${{ needs.expected-artifacts.outputs.expected_tags }}; do
            if echo "$all_tags" | grep -q "^${tag}$"; then
              echo "✓ Tag $tag exists"
            else
              echo "✗ Tag $tag is missing"
              missing_tags+=("$tag")
            fi
          done

          # Report results
          if [ ${#missing_tags[@]} -eq 0 ]; then
            echo "✅ All expected tags are present"
          else
            echo "❌ Missing tags: ${missing_tags[*]}"
            exit 1
          fi

      - name: Validate draft branch exists
        run: |
          echo "Validating draft branches for ${{ matrix.repo_short }}..."

          # Get all remote branches
          git fetch --all
          all_branches=$(git branch -r)

          expected_branches="${{ needs.expected-artifacts.outputs.expected_branches }}"

          # Check each expected branch exists
          missing_branches=()
          for branch in $expected_branches; do
            if echo "$all_branches" | grep -q "origin/${branch}$"; then
              echo "✓ Branch $branch exists"
            else
              echo "✗ Branch $branch is missing"
              missing_branches+=("$branch")
            fi
          done

          # Report results
          if [ ${#missing_branches[@]} -eq 0 ]; then
            echo "✅ All expected branches are present"
          else
            echo "❌ Missing branches: ${missing_branches[*]}"
            echo "Available branches:"
            echo "$all_branches" | grep "draft-" || echo "No draft branches found"
            exit 1
          fi

      - name: Validate non expected tags do not exist
        run: |
          echo "Validating non expected tags do not exist for ${{ matrix.repo_short }}..."

          # Get all tags on draft release branch
          all_tags=$(git tag --merged origin/${{ needs.expected-artifacts.outputs.draft_release_branch }} --sort=creatordate --sort=taggerdate )

          # Check each non expected tag does not exist
          for tag in ${{ needs.expected-artifacts.outputs.non_expected_tags }}; do
            if echo "$all_tags" | grep -q "^${tag}$"; then
              echo "✗ Tag $tag should not exist"
              exit 1
            else
              echo "✓ Tag $tag does not exist"
            fi
          done

          echo "✅ All non expected tags do not exist"

      - name: Validate draft releases exist
        run: |
          echo "Validating draft releases for ${{ matrix.repo_short }}..."

          # Get all releases from the repository
          releases=$(gh release list --repo tenstorrent/tt-forge --limit 100 --json tagName,isDraft | jq -r '.[] | select(.isDraft == true) | .tagName')

          # Check each expected tag has a corresponding draft release
          missing_releases=()
          for tag in ${{ needs.expected-artifacts.outputs.expected_release_tags }}; do
            if echo "$releases" | grep -q "^${tag}$"; then
              echo "✓ Draft release $tag exists"
            else
              echo "✗ Draft release $tag is missing"
              missing_releases+=("$tag")
            fi
          done

          # Report results
          if [ ${#missing_releases[@]} -eq 0 ]; then
            echo "✅ All expected draft releases are present"
          else
            echo "❌ Missing draft releases: ${missing_releases[*]}"
            echo "Available draft releases:"
            echo "$releases" | grep "draft.${{ matrix.repo_short }}" || echo "No matching draft releases found"
            exit 1
          fi

      - name: Summary
        run: |
          echo "🎉 Validation completed successfully for ${{ matrix.repo_short }}!"
          echo "✅ All draft tags verified"
          echo "✅ Draft branch verified"
          echo "✅ All draft releases verified"

  delete-draft-artifacts:
    if: always()
    needs:
      - validate-draft-artifacts
      - expected-artifacts
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete test tags
        if: ${{ inputs.delete-drafts || true }}
        run: |
          draft_tags=$(git tag -l | grep -oP "^draft\.tt-mlir\..+" | xargs || true)
          echo "draft_tags=$draft_tags"
          for tag in $draft_tags; do
            git push origin --delete $tag || true
          done

      - name: Delete draft branch branches
        if: ${{ inputs.delete-drafts || true }}
        run: |
          draft_branches=$(git branch -r | grep -oP "(?<=origin\/)draft-tt-\w+-release-(?=\d|mock).+" | xargs || true)
          echo "draft_branches=$draft_branches"
          for branch in $draft_branches; do
            git push origin --delete $branch || true
          done

      - name: Delete draft releases
        if: ${{ inputs.delete-drafts || github.event_name != 'workflow_dispatch' }}
        run: |
          echo "Deleting draft releases..."
          draft_releases=$(gh release list --repo tenstorrent/tt-forge --limit 100 --json tagName,isDraft | jq -r '.[] | select(.isDraft == true) | select(.tagName | startswith("draft.tt-")) | .tagName')

          if [ -n "$draft_releases" ]; then
            echo "Found draft releases to delete:"
            echo "$draft_releases"

            # Delete each draft release
            echo "$draft_releases" | while read -r release_tag; do
              if [ -n "$release_tag" ]; then
                echo "Deleting draft release: $release_tag"
                gh release delete "$release_tag" --repo tenstorrent/tt-forge --yes || echo "Failed to delete release $release_tag"
              fi
            done
          else
            echo "No draft releases found to delete"
          fi
