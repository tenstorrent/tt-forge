name: "[internal] Collect workflow data"
run-name: "Collect data for run_id ${{ github.event.workflow_run.id }} attempt ${{ github.event.workflow_run.run_attempt }}"

on:
  workflow_run:
    workflows:
      - "Perf*"
    types:
      - completed

jobs:
  produce-cicd-data:
    runs-on: ubuntu-latest
    env:
        GH_TOKEN: ${{ github.token }}
    steps:
      - name: Check event workflow run
        id: skip_collect_data
        run: |
          # Due to dymanic named workflow, we can't match on the workflow name directly. Here we do a regex match on the workflow name to determine if we should collect data.
          # https://github.com/tenstorrent/tt-github-actions/issues/88#issuecomment-3452943178
          skip_collect_data="true"
          workflow_name="${{ github.event.workflow_run.name }}"
          echo "workflow_name: $workflow_name"
          if [[ "$workflow_name" =~ "Perf" ]]; then
            skip_collect_data="false"
          fi
          echo "skip_collect_data: $skip_collect_data" >> $GITHUB_OUTPUT
      - name: Collect CI/CD data
        if: ${{ steps.skip_collect_data.outputs.skip_collect_data == 'false' }}
        uses: tenstorrent/tt-github-actions/.github/actions/collect_data@main
        with:
          repository: ${{ github.repository }}
          run_id: ${{ inputs.run_id || github.event.workflow_run.id }}
          run_attempt: ${{ inputs.run_attempt || github.event.workflow_run.run_attempt }}
          sftp_host: ${{ secrets.SFTP_CICD_WRITER_HOSTNAME }}
          sftp_user: ${{ secrets.SFTP_CICD_WRITER_USERNAME }}
          sftp_perf_host: ${{ secrets.SFTP_PERF_WRITER_HOSTNAME }}
          sftp_perf_user: ${{ secrets.SFTP_PERF_WRITER_USERNAME }}
          ssh-private-key: ${{ secrets.SFTP_CICD_WRITER_KEY }}
