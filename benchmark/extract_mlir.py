# SPDX-FileCopyrightText: Â© 2024 Tenstorrent AI ULC

# SPDX-License-Identifier: Apache-2.0

"""
Script to extract the first MLIR model generated from `ttrt read --section mlir`.
"""

import re
import sys


def extract_mlir(input_file, output_file):
    """
    Extract the first MLIR model from output of `ttrt read --section mlir`.

    Args:
        input_file: Path to the input file generated by `ttrt read --section mlir`.
        output_file: Path to write the cleaned MLIR output.
    """
    try:
        with open(input_file, "r") as f:
            content = f.read()

        # Use regex to find the "ttnn" field value
        pattern = r'"ttnn":\s*"(.+)"'
        match = re.search(pattern, content)

        if not match:
            print("Error: Could not find MLIR content in the input file")
            return False

        mlir_content = match.group(1)

        # Replace escaped characters
        # Replace \n with actual newlines
        mlir_content = mlir_content.replace("\\n", "\n")
        # Replace \" with actual quotes
        mlir_content = mlir_content.replace('\\"', '"')

        # Write the cleaned MLIR to output file
        with open(output_file, "w") as f:
            f.write(mlir_content)

        print(f"Successfully extracted MLIR to {output_file}")
        return True

    except FileNotFoundError:
        print(f"Error: Input file '{input_file}' not found")
        return False
    except Exception as e:
        print(f"Error processing file: {e}")
        return False


def main():
    if len(sys.argv) < 2:
        print("Usage: python extract_mlir.py <input_file> [output_file]")
        print("If output_file is not specified, will use 'extracted.mlir'")
        sys.exit(1)

    input_file = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "extracted.mlir"

    if extract_mlir(input_file, output_file):
        sys.exit(0)
    else:
        sys.exit(1)


if __name__ == "__main__":
    main()
